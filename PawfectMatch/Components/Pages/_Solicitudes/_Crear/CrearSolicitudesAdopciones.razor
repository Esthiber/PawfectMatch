@page "/Crear/SolicitudesAdopciones/mascotaID={id:int}"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using PawfectMatch.Models._Solicitudes
@using PawfectMatch.Models._Mascotas
@attribute [Authorize]

@inject SolicitudesAdopcionesService solicitudesAdopcionesService
@inject AdoptantesService adoptantesService
@inject MascotasService mascotasService
@inject AuthenticationStateProvider authProvider

@rendermode InteractiveServer

<h3>Crear Solicitud de Adopción</h3>

@if (mensajeExito is not null)
{
    <div class="alert alert-success">@mensajeExito</div>
}

@if (error is not null)
{
    <div class="alert alert-danger">@error</div>
}

<EditForm Model="@solicitud" OnValidSubmit="GuardarSolicitud">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label>Mascota:</label>
        <div class="card p-3">
            <img src="@mascota.FotoUrl" alt="Foto de la mascota" width="200" class="mb-2" />
            <p><strong>Nombre:</strong> @mascota.Nombre</p>
            <p><strong>Categoría:</strong> @mascota.Categoria.Nombre</p>
            <p><strong>Tamaño:</strong> @mascota.RelacionSize.Size</p>
            <p><strong>Estado:</strong> @mascota.Estado.Nombre</p>
            <p><strong>Descripción:</strong> @mascota.Descripcion</p>
        </div>
    </div>

    <div class="mb-3">
        <label>Información del Adoptante:</label>
        <div class="card p-3">
            <p><strong>Nombre:</strong> @adoptanteActual?.Nombre</p>
            <p><strong>Correo electrónico:</strong> @correoUsuario</p>
            <p><strong>Correo electrónico:</strong> @adoptanteActual?.Ocupacion</p>
        </div>
    </div>


    <button class="btn btn-primary" type="submit">Enviar solicitud</button>
</EditForm>

@code {
    [Parameter]
    public int id { get; set; }
    private SolicitudesAdopciones solicitud = new();
    private Mascotas mascota = new();
    private string? mensajeExito { get; set; }
    private string? error { get; set; }
    private Adoptantes? adoptanteActual;
    private string? correoUsuario;

    protected override async Task OnInitializedAsync()
    {
        solicitud.Fecha = DateTime.Now;
        solicitud.EstadoSolicitudId = 1; // Asumiendo que 1 = "Pendiente"

        var authState = await authProvider.GetAuthenticationStateAsync();
        var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        if (userId is not null)
        {
            var adoptantes = await adoptantesService.ListAsync(a => a.UsuarioId == userId);
            var adoptante = adoptantes.FirstOrDefault();

            adoptanteActual = adoptante;
            correoUsuario = authState.User.FindFirst(ClaimTypes.Email)?.Value;

            if (adoptante is not null)
            {
                solicitud.AdoptanteId = adoptante.AdoptanteId;
                mascota = await mascotasService.SearchByIdAsync(id);
            }
            else
            {
                error = "No se encontró el adoptante vinculado al usuario.";
            }
        }
    }

    private async Task GuardarSolicitud()
    {
        if (solicitud.AdoptanteId == 0 || solicitud.MascotaId == 0)
        {
            error = "Debe seleccionar una mascota.";
            return;
        }

        bool guardado = await solicitudesAdopcionesService.InsertAsync(solicitud);
        if (guardado)
        {
            mensajeExito = "¡Solicitud enviada con éxito!";
            solicitud = new() { Fecha = DateTime.Now, EstadoSolicitudId = 1 };
        }
        else
        {
            error = "Error al enviar la solicitud.";
        }
    }
}
